---
# Tutorial de inspiração para a infraestrutura conduzida por teste no site
# https://www.adictosaltrabajo.com/2020/05/08/ansible-testing-using-molecule-with-ansible-as-verifier/

- name: "Infraestrutura conduzida por testes"
  hosts: all
  gather_facts: false
  become: true

  tasks:
  - name: "Simulação: Atualizar a cache do sistema"
    apt:
      update_cache: true
      cache_valid_time: 3600
    check_mode: true
    register: estado

  - name: "teste: a cache encontra-se actualizada?"
    assert:
      that:
      - not estado.changed
      success_msg: "SUCESSO: A cache está atualizada"
      fail_msg: "ERRO: Existem actualizações pendentes"

  - name: "Atualizar o sistema operativo (equivalente a apt upgrade)"
    apt:
      upgrade: safe
    check_mode: true
    register: estado

  - name: "teste: o sistema operativo encontra-se atualizado?"
    assert:
      that:
      - not estado.changed
      success_msg: "SUCESSO: O sistema operativo está atualizado"
      fail_msg: "ERRO: Existem actualizações pendentes"

  - name: "Teste: a cache encontra-se atualizada?"
    assert:
      that:
      - not estado.changed
      success_msg: "SUCESSO: A cache está atualizada"
      fail_msg: "ERRO: Existem atualizações pendentes"

  - name: "Simulação: testa se as aplicações dependencia do software leantime se encontram instaladas"
    apt:
      pkg:
      - mc
      - screen
      - git
      - apache2
      - mysql-server
      - php
      - php-mysql
      - php-ldap
      - php-cli
      - php-soap
      - php-json
      - graphviz
      - php-xml
      - php-gd
      - php-zip
      - libapache2-mod-php
      - php-dev
      - libmcrypt-dev
      - gcc
      - make
      - autoconf
      - libc-dev
      - pkg-config
      - pwgen
      - curl
      - unzip
      - zip
      - php-mbstring
      - expect
      - net-tools
      - python3-mysqldb
      - python3-apt
      - python3-pycurl
    check_mode: true
    register: estado

  - name: "Teste: as dependencias encontra-se instaladas?"
    assert:
      that:
      - not estado.changed
      success_msg: "SUCESSO: As dependencias estavam instaladas"
      fail_msg: "ERRO: Faltam instalar algumas dependencias. O software pode estar parcialmente instalado"
